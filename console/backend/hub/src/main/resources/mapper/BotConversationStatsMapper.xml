<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iflytek.astron.console.hub.mapper.BotConversationStatsMapper">


    <!-- Query summary statistics data -->
    <select id="selectSummaryStats" resultType="com.iflytek.astron.console.hub.dto.publish.BotSummaryStatsVO">
        SELECT 
            COALESCE(SUM(token_consumed), 0) as totalTokens,
            COUNT(DISTINCT chat_id) as totalChats,
            COUNT(DISTINCT uid) as totalUsers,
            COALESCE(SUM(message_rounds), 0) as totalMessages
        FROM bot_conversation_stats 
        WHERE bot_id = #{botId} 
          AND is_delete = 0
          <if test="uid != null">
              AND uid = #{uid}
          </if>
          <if test="spaceId != null">
              AND space_id = #{spaceId}
          </if>
    </select>

    <!-- Query time series statistics data -->
    <select id="selectTimeSeriesStats" resultType="com.iflytek.astron.console.hub.dto.publish.BotTimeSeriesStatsVO">
        SELECT 
            conversation_date as date,
            COUNT(DISTINCT chat_id) as chatCount,
            COUNT(DISTINCT uid) as userCount,
            COALESCE(SUM(token_consumed), 0) as tokenCount,
            COALESCE(SUM(message_rounds), 0) as messageCount
        FROM bot_conversation_stats 
        WHERE bot_id = #{botId} 
          AND conversation_date >= #{startDate}
          AND is_delete = 0
          <if test="uid != null">
              AND uid = #{uid}
          </if>
          <if test="spaceId != null">
              AND space_id = #{spaceId}
          </if>
        GROUP BY conversation_date
        ORDER BY conversation_date
    </select>


</mapper>
